# ============================================================================
# correlation_searches.conf — Multi-Event Correlation Rules
# ============================================================================
# These searches correlate events across multiple data sources and time
# windows to detect complex attack chains that single-event rules miss.
# Deploy: $SPLUNK_HOME/etc/apps/detection_lab/local/savedsearches.conf
# ============================================================================

[Correlation - Attack Chain: Recon → Exploit → Escalate]
description = Detects full attack lifecycle: web scanning followed by successful SQLi followed by privileged access
search = index=attack_sim \
  | eval phase = case( \
      match(user_agent, "(?i)(sqlmap|nikto|burp)"), "1_recon", \
      attack_type="sqli" AND status_code=200, "2_exploit", \
      match(username, "(?i)(admin|root)") AND action="success", "3_escalate", \
      1=1, "benign" \
    ) \
  | where phase!="benign" \
  | bin _time span=1h \
  | stats dc(phase) AS phases_seen, values(phase) AS attack_phases, \
      values(hostname) AS targets BY src_ip, _time \
  | where phases_seen >= 2 \
  | eval severity = if(phases_seen >= 3, "critical", "high"), \
      alert_name = "Attack Chain Detected: " . mvjoin(attack_phases, " → ")
dispatch.earliest_time = -2h
dispatch.latest_time = now
cron_schedule = */15 * * * *
is_scheduled = 1
alert_type = number of events
alert_comparator = greater than
alert_threshold = 0
alert.severity = 5
action.email.to = soc@company.com,ir-team@company.com
action.email.subject = [CRITICAL] Multi-Phase Attack Chain from $result.src_ip$

[Correlation - C2 Beaconing Detection]
description = Identifies regular-interval HTTP callbacks indicating C2 communication
search = index=attack_sim sourcetype="attack_sim:proxy" event_type="http_request" \
  | sort _time \
  | streamstats current=f last(_time) AS prev_time BY src_ip, domain \
  | eval interval = _time - prev_time \
  | where isnotnull(interval) AND interval > 0 \
  | stats count AS callbacks, avg(interval) AS avg_interval, \
      stdev(interval) AS stdev_interval, \
      values(domain) AS contacted_domains BY src_ip \
  | eval jitter_ratio = round(stdev_interval / avg_interval, 3) \
  | where callbacks >= 10 AND jitter_ratio < 0.3 AND avg_interval < 300 \
  | eval severity = "critical", \
      alert_name = "C2 Beaconing: " . src_ip . " every " . round(avg_interval, 0) . "s to " . contacted_domains
dispatch.earliest_time = -4h
dispatch.latest_time = now
cron_schedule = */30 * * * *
is_scheduled = 1
alert_type = number of events
alert_comparator = greater than
alert_threshold = 0
alert.severity = 5
action.email.to = soc@company.com,ir-team@company.com
action.email.subject = [CRITICAL] C2 Beaconing: $result.src_ip$ (interval: $result.avg_interval$s)

[Correlation - Brute Force to Lateral Movement]
description = Detects successful brute force followed by lateral movement from compromised host
search = index=attack_sim sourcetype="attack_sim:auth" \
  | bin _time span=1h \
  | stats \
      count(eval(action="failure" AND NOT cidrmatch("10.0.0.0/8", src_ip))) AS ext_failures, \
      count(eval(action="success" AND NOT cidrmatch("10.0.0.0/8", src_ip))) AS ext_successes, \
      values(eval(if(action="success", dst_ip, null()))) AS compromised_hosts \
    BY _time \
  | where ext_failures >= 10 AND ext_successes >= 1 \
  | eval compromised_ip = mvindex(compromised_hosts, 0) \
  | join type=left compromised_ip \
    [search index=attack_sim sourcetype="attack_sim:auth" action="success" \
      | where cidrmatch("10.0.0.0/8", src_ip) \
      | rename src_ip AS compromised_ip \
      | stats dc(dst_ip) AS internal_hops BY compromised_ip] \
  | where isnotnull(internal_hops) AND internal_hops >= 2 \
  | eval severity = "critical", \
      alert_name = "Brute Force → Lateral Movement chain via " . compromised_ip
dispatch.earliest_time = -2h
dispatch.latest_time = now
cron_schedule = */15 * * * *
is_scheduled = 1
alert_type = number of events
alert_comparator = greater than
alert_threshold = 0
alert.severity = 5
action.email.to = ir-team@company.com
action.email.subject = [CRITICAL] Attack Chain: Brute Force → Compromise → Lateral Movement
