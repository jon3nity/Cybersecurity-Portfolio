# ============================================================================
# critical_alerts.conf — Splunk Saved Search Alert Definitions
# ============================================================================
# Deploy: Copy to $SPLUNK_HOME/etc/apps/detection_lab/local/savedsearches.conf
# These define alert triggers, schedules, and actions for each detection rule.
# ============================================================================

[Brute Force - Threshold Alert]
description = Fires when a single source IP generates 10+ auth failures in 5 minutes
search = index=attack_sim sourcetype="attack_sim:auth" action="failure" \
  | bin _time span=5m \
  | stats count AS failure_count, dc(username) AS targeted_accounts BY src_ip, hostname \
  | where failure_count >= 10
dispatch.earliest_time = -10m
dispatch.latest_time = now
cron_schedule = */5 * * * *
is_scheduled = 1
alert_type = number of events
alert_comparator = greater than
alert_threshold = 0
alert.severity = 4
alert.suppress = 1
alert.suppress.period = 30m
alert.suppress.fields = src_ip
action.email.to = soc@company.com
action.email.subject = [ALERT] Brute Force Detected: $result.src_ip$ → $result.hostname$

[Brute Force - Compromise Indicator]
description = CRITICAL: Successful login detected after multiple authentication failures
search = index=attack_sim sourcetype="attack_sim:auth" \
  | bin _time span=10m \
  | stats count(eval(action="failure")) AS failures, count(eval(action="success")) AS successes BY src_ip, dst_ip \
  | where failures >= 5 AND successes >= 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */5 * * * *
is_scheduled = 1
alert_type = number of events
alert_comparator = greater than
alert_threshold = 0
alert.severity = 5
alert.suppress = 1
alert.suppress.period = 1h
alert.suppress.fields = src_ip
action.email.to = soc@company.com,ir-team@company.com
action.email.subject = [CRITICAL] Potential Compromise: $result.src_ip$

[SQL Injection - Signature Alert]
description = Detects SQL injection payloads in HTTP request URLs
search = index=attack_sim sourcetype="attack_sim:web" \
  | eval url_decoded = urldecode(url) \
  | where match(url_decoded, "(?i)(union.*select|drop\s+table|xp_cmdshell|information_schema)") \
  | stats count AS attempts BY src_ip, hostname \
  | where attempts >= 3
dispatch.earliest_time = -10m
dispatch.latest_time = now
cron_schedule = */5 * * * *
is_scheduled = 1
alert_type = number of events
alert_comparator = greater than
alert_threshold = 0
alert.severity = 5
alert.suppress = 1
alert.suppress.period = 30m
alert.suppress.fields = src_ip
action.email.to = soc@company.com
action.email.subject = [CRITICAL] SQL Injection Detected from $result.src_ip$

[Data Exfiltration - Volume Alert]
description = Large outbound data transfer to external destination exceeding threshold
search = index=attack_sim sourcetype="attack_sim:netflow" \
  | eval bytes_out_mb = round(bytes_out / 1048576, 2) \
  | where bytes_out_mb >= 50 \
  | eval is_external = if(NOT cidrmatch("10.0.0.0/8", dst_ip), 1, 0) \
  | where is_external=1
dispatch.earliest_time = -30m
dispatch.latest_time = now
cron_schedule = */15 * * * *
is_scheduled = 1
alert_type = number of events
alert_comparator = greater than
alert_threshold = 0
alert.severity = 5
alert.suppress = 1
alert.suppress.period = 1h
alert.suppress.fields = src_ip,dst_ip
action.email.to = soc@company.com,dlp-team@company.com
action.email.subject = [CRITICAL] Data Exfiltration: $result.hostname$ → $result.domain$ ($result.bytes_out_mb$ MB)

[Lateral Movement - Multi-Host Alert]
description = Single internal IP authenticating to 3+ hosts in 30 minutes
search = index=attack_sim sourcetype="attack_sim:auth" action="success" \
  | where cidrmatch("10.0.0.0/8", src_ip) OR cidrmatch("192.168.0.0/16", src_ip) \
  | bin _time span=30m \
  | stats dc(dst_ip) AS unique_targets BY src_ip \
  | where unique_targets >= 3
dispatch.earliest_time = -35m
dispatch.latest_time = now
cron_schedule = */15 * * * *
is_scheduled = 1
alert_type = number of events
alert_comparator = greater than
alert_threshold = 0
alert.severity = 4
alert.suppress = 1
alert.suppress.period = 1h
alert.suppress.fields = src_ip
action.email.to = soc@company.com
action.email.subject = [HIGH] Lateral Movement: $result.src_ip$ accessed $result.unique_targets$ hosts
